<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onyx Casino | Realismo Pro</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.0/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.0/brython_stdlib.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --onyx: #0f0f0f;
            --gold: #d4af37;
            --gold-light: #f1d592;
            --glass: rgba(15, 15, 15, 0.95);
            --danger: #ff4b2b;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: #050505;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .casino-container {
            width: 95%;
            max-width: 420px;
            background: var(--glass);
            border: 1px solid var(--gold);
            border-radius: 28px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        /* --- CARRETE REALISTA --- */
        #canvas-container {
            position: relative;
            margin: 20px auto;
            width: 140px;
            height: 220px;
            border: 4px solid var(--gold);
            border-radius: 15px;
            background: #000;
            overflow: hidden;
            box-shadow: 
                inset 0 25px 40px rgba(0,0,0,1), 
                inset 0 -25px 40px rgba(0,0,0,1),
                0 0 20px rgba(212, 175, 55, 0.3);
        }

        /* Reflejo de cristal superior */
        #canvas-container::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
            z-index: 5;
        }

        /* Marcador de selecci√≥n (Rojo/Oro) */
        #canvas-container::after {
            content: "";
            position: absolute;
            top: 50%;
            left: -5px;
            right: -5px;
            height: 4px;
            background: var(--gold);
            box-shadow: 0 0 15px var(--gold);
            transform: translateY(-50%);
            z-index: 10;
        }

        canvas { display: block; }

        /* --- INTERFAZ --- */
        .puntos-display { font-size: 2.2rem; font-weight: 800; color: white; margin-bottom: 5px; }
        .puntos-display span { color: var(--gold); font-size: 1rem; }
        
        .intentos-badge {
            background: rgba(212,175,55,0.1);
            border: 1px solid var(--gold);
            padding: 4px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--gold-light);
        }

        .seccion-apuesta {
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            padding: 15px;
            margin-top: 15px;
        }

        .grid-opciones {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 12px 0;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #444;
            border-radius: 10px;
            color: var(--gold-light);
            text-align: center;
            box-sizing: border-box;
            font-size: 1rem;
        }

        button { cursor: pointer; transition: 0.2s; font-weight: bold; border: none; }

        .btn-principal {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #d4af37, #f1d592);
            border-radius: 12px;
            color: black;
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .btn-secundario {
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .btn-secundario.active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }

        #btn-extra {
            background: transparent;
            color: var(--gold-light);
            text-decoration: underline;
            font-size: 0.8rem;
            margin-top: 12px;
            display: block;
            width: 100%;
        }

        .label-mini { display: block; font-size: 0.65rem; color: #888; margin-bottom: 4px; text-transform: uppercase; }
        #mensaje { margin-top: 15px; font-size: 0.95rem; font-weight: bold; color: var(--gold-light); }
    </style>
</head>

<body onload="brython()">

<div class="casino-container animate__animated animate__fadeIn">
    <h2 style="margin:0; letter-spacing:4px; color:var(--gold);">ONYX REEL</h2>
    
    <div class="puntos-display" id="puntos">1,000 <span>TOKEN</span></div>
    <div class="intentos-badge" id="intentos-display">Cargas: 5 / 5</div>

    <div id="canvas-container">
        <canvas id="ruleta" width="140" height="220"></canvas>
    </div>

    <div class="seccion-apuesta">
        <span class="label-mini">Monto de la Apuesta</span>
        <input type="number" id="monto-apuesta" value="100" min="10">

        <div class="grid-opciones">
            <button class="btn-secundario active" id="bet-exacto">N√∫mero (x15)</button>
            <button class="btn-secundario" id="bet-paridad">Paridad (x2)</button>
            <button class="btn-secundario" id="bet-rango">Rango (x2)</button>
            <select id="sub-opcion"></select>
        </div>

        <button class="btn-principal" id="btn-girar">Girar Carrete</button>
        <button id="btn-extra">Comprar Carga (+1) por 20 Tokens</button>
        <button class="btn-principal" id="btn-reiniciar" style="display:none; background: var(--danger); color:white;">Reiniciar Juego</button>
    </div>

    <p id="mensaje">¬°Haz tu apuesta!</p>
</div>
<script type="text/python">
from browser import document, window, timer, html
import random
import time
import math

# Configuraci√≥n
puntos = 1000
intentos = 5
tipo_apuesta = "exacto"
numeros_carrete = list(range(1, 21))
canvas = document["ruleta"]
ctx = canvas.getContext("2d")
altura_item = 70
offset_y = 0
girando = False

def render_carrete(pos_y, velocidad=0):
    ctx.clearRect(0, 0, canvas.width, canvas.height)

    # 1. Fondo con efecto cilindro
    grad_fondo = ctx.createLinearGradient(0, 0, 0, canvas.height)
    grad_fondo.addColorStop(0, "#000000")
    grad_fondo.addColorStop(0.5, "#111111")
    grad_fondo.addColorStop(1, "#000000")
    ctx.fillStyle = grad_fondo
    ctx.fillRect(0, 0, canvas.width, canvas.height)

    ctx.textAlign = "center"
    ctx.textBaseline = "middle"

    # Motion Blur: Determinar cu√°ntas sombras dibujar
    pasos_blur = 1
    if abs(velocidad) > 30: pasos_blur = 3

    centro_c = canvas.height / 2
    total_items = len(numeros_carrete)

    # Dibujar un n√∫mero suficiente de elementos arriba/abajo para simular loop infinito.
    for i in range(-5, total_items + 5):
        # Usar pos_y directamente (no modulo) para mantener coherencia en el centrado final
        base_y = (i * altura_item) + pos_y
        num = numeros_carrete[i % total_items]

        # Evitar dibujar elementos fuera del √°rea visible
        if base_y < -altura_item or base_y > canvas.height + altura_item:
            continue

        # Efecto de curvatura 3D
        dist_centro = abs((base_y + altura_item/2) - centro_c)

        # Escala y Opacidad seg√∫n distancia al centro
        escala = max(0.4, 1.1 - (dist_centro / centro_c))
        opacidad = max(0.0, 1.0 - (dist_centro / centro_c))

        # Dibujar con Motion Blur
        for b in range(pasos_blur):
            y_blur = base_y + (b * velocidad * 0.015)  # menor desplazamiento por frame para m√°s suavidad

            if dist_centro < (altura_item / 2): # Elemento seleccionado (umbral: mitad del item)
                ctx.fillStyle = f"rgba(241, 213, 146, {opacidad})"
                ctx.font = f"bold {int(55 * escala)}px 'Trebuchet MS'"
                ctx.shadowBlur = 15
                ctx.shadowColor = "#d4af37"
            else: # Elementos secundarios
                ctx.fillStyle = f"rgba(212, 175, 55, {opacidad * 0.4})"
                ctx.font = f"bold {int(42 * escala)}px 'Trebuchet MS'"
                ctx.shadowBlur = 0

            ctx.fillText(str(num), canvas.width/2, y_blur + altura_item/2)
            ctx.shadowBlur = 0

    # 2. Sombras de bordes (Overlay)
    grad_over = ctx.createLinearGradient(0, 0, 0, canvas.height)
    grad_over.addColorStop(0, "rgba(0,0,0,0.9)")
    grad_over.addColorStop(0.25, "rgba(0,0,0,0)")
    grad_over.addColorStop(0.75, "rgba(0,0,0,0)")
    grad_over.addColorStop(1, "rgba(0,0,0,0.9)")
    ctx.fillStyle = grad_over
    ctx.fillRect(0, 0, canvas.width, canvas.height)

def animar_giro(objetivo_idx, duracion, inicio_time, inicio_offset):
    global offset_y, girando
    ahora = time.time()
    progreso = (ahora - inicio_time) / duracion

    if progreso >= 1:
        # Final exacto: alinear el √≠ndice objetivo al centro
        offset_y = (canvas.height/2 - altura_item/2) - (objetivo_idx * altura_item)
        render_carrete(offset_y, 0)
        girando = False
        # Llamamos a finalizar despu√©s de un peque√±o retardo para asegurar render y UX (50ms)
        timer.set_timeout(lambda: finalizar_juego(numeros_carrete[objetivo_idx]), 50)
        return

    # Easing: "Back Out" (rebote mec√°nico)
    s = 1.2
    p_inv = 1 - progreso
    p = 1 - (p_inv**3 * (1 - progreso * (s * p_inv - s)))

    vueltas = 10
    distancia_total = (len(numeros_carrete) * vueltas * altura_item)
    actual_pos = inicio_offset - (distancia_total * p)

    # Velocidad para el desenfoque (ajustada)
    velocidad = (distancia_total / duracion) * (1 - progreso) * 0.9

    offset_y = actual_pos
    render_carrete(actual_pos, velocidad)
    # requestAnimationFrame -> continuar animaci√≥n
    window.requestAnimationFrame(lambda t: animar_giro(objetivo_idx, duracion, inicio_time, inicio_offset))

def actualizar_ui():
    document['puntos'].html = f"{puntos:,} <span>TOKEN</span>"
    document['intentos-display'].text = f"Cargas: {intentos} / 5"

def cambiar_tipo(ev):
    global tipo_apuesta
    for b in ['bet-exacto', 'bet-paridad', 'bet-rango']:
        document[b].classList.remove('active')

    ev.target.classList.add('active')
    tipo_apuesta = ev.target.id.split('-')[1]

    select = document['sub-opcion']
    select.html = ""
    if tipo_apuesta == "exacto":
        for i in range(1, 21): select <= html.OPTION(str(i), value=str(i))
    elif tipo_apuesta == "paridad":
        select <= html.OPTION("PAR", value="par")
        select <= html.OPTION("IMPAR", value="impar")
    elif tipo_apuesta == "rango":
        select <= html.OPTION("BAJO (1-10)", value="bajo")
        select <= html.OPTION("ALTO (11-20)", value="alto")

def iniciar_giro(ev):
    global puntos, intentos, girando, offset_y
    if girando or intentos <= 0: return

    try:
        monto = int(document['monto-apuesta'].value)
    except:
        document['mensaje'].text = "‚ö†Ô∏è Ingresa un monto v√°lido"; return

    if monto > puntos:
        document['mensaje'].text = "üö´ Fondos insuficientes"; return

    intentos -= 1
    puntos -= monto
    girando = True
    actualizar_ui()
    document['mensaje'].text = "üé∞ Girando carrete..."

    ganador_idx = random.randint(0, len(numeros_carrete)-1)
    # pasar el offset actual para continuidad en la animaci√≥n
    animar_giro(ganador_idx, 3.5, time.time(), offset_y)

def finalizar_juego(resultado):
    global puntos
    sub_val = document['sub-opcion'].value
    try:
        monto = int(document['monto-apuesta'].value)
    except:
        monto = 0
    gana = False
    premio = 0

    if tipo_apuesta == "exacto" and str(resultado) == sub_val:
        premio = monto * 15; gana = True
    elif tipo_apuesta == "paridad":
        if (sub_val == "par" and resultado % 2 == 0) or (sub_val == "impar" and resultado % 2 != 0):
            premio = monto * 2; gana = True
    elif tipo_apuesta == "rango":
        if (sub_val == "bajo" and 1 <= resultado <= 10) or (sub_val == "alto" and 11 <= resultado <= 20):
            premio = monto * 2; gana = True

    if gana:
        puntos += premio
        document['mensaje'].text = f"üî• ¬°ACIERTO! Sali√≥ {resultado}"
        window.confetti({'particleCount': 120, 'spread': 70, 'origin': {'y': 0.6}})
    else:
        document['mensaje'].text = f"‚ùå Perdiste. Cay√≥ el {resultado}"

    actualizar_ui()
    if puntos <= 0 and intentos <= 0:
        document['btn-girar'].style.display = "none"
        document['btn-reiniciar'].style.display = "block"
        document['mensaje'].text = "üíÄ BANCARROTA"

def comprar_carga(ev):
    global puntos, intentos
    if puntos >= 20:
        puntos -= 20
        intentos += 1
        actualizar_ui()
        document['mensaje'].text = "‚ö° +1 Carga a√±adida"
    else:
        document['mensaje'].text = "‚ö†Ô∏è Necesitas 20 tokens"

def reiniciar(ev):
    global puntos, intentos, offset_y, girando
    puntos, intentos = 1000, 5
    offset_y = 0
    girando = False
    document['btn-girar'].style.display = "block"
    document['btn-reiniciar'].style.display = "none"
    actualizar_ui()
    document['mensaje'].text = "¬°Mesa lista!"

# Eventos
document['btn-girar'].bind('click', iniciar_giro)
document['btn-extra'].bind('click', comprar_carga)
document['btn-reiniciar'].bind('click', reiniciar)
document['bet-exacto'].bind('click', cambiar_tipo)
document['bet-paridad'].bind('click', cambiar_tipo)
document['bet-rango'].bind('click', cambiar_tipo)

# Inicio
render_carrete(0)
cambiar_tipo(type('obj', (object,), {'target': document['bet-exacto']}))
actualizar_ui()
</script>
</body>
</html>